{"version":3,"sources":["../../src/view/node.js"],"names":["ControlView","Drag","Emitter","SocketView","NodeView","constructor","node","component","emitter","Map","el","document","createElement","style","position","addEventListener","e","trigger","_drag","onTranslate","bind","onSelect","data","bindSocket","bindControl","update","clearSockets","ios","inputs","values","outputs","sockets","forEach","s","includes","io","delete","type","set","control","controls","getSocketPosition","socket","get","Error","name","key","getPosition","payload","accumulate","ctrlKey","onStart","_startPosition","dx","dy","onDrag","x","y","translate","params","px","py","prev","transform","remove","destroy"],"mappings":"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","sourcesContent":["import { ControlView } from './control.js';\nimport { Drag } from './drag.js';\nimport { Emitter } from '../core.js';\nimport { SocketView } from './socket.js';\n\nexport class NodeView extends Emitter {\n\n    node;\n    component;\n    sockets = new Map();\n    controls = new Map();\n\n    el;\n    _startPosition = [];\n    _drag;\n\n    constructor(node, component, emitter) {\n        super(emitter);\n\n        this.node = node;\n        this.component = component;\n        this.el = document.createElement('div');\n        this.el.style.position = 'absolute';\n\n        this.el.addEventListener('contextmenu', e => this.trigger('contextmenu', { e, node: this.node }));\n\n        this._drag = new Drag(this.el, this.onTranslate.bind(this), this.onSelect.bind(this), () => {\n            this.trigger('nodedraged', node);\n            this.trigger('nodedragged', node);\n        });\n\n        this.trigger('rendernode', {\n            el: this.el, \n            node, \n            component: component.data, \n            bindSocket: this.bindSocket.bind(this),\n            bindControl: this.bindControl.bind(this)\n        });\n\n        this.update();\n    }\n\n    clearSockets() {\n        const ios = [ ...this.node.inputs.values(), ...this.node.outputs.values()];\n        \n        this.sockets.forEach(s => {\n            if (!ios.includes(s.io)) this.sockets.delete(s.io);\n        });\n    }\n\n    bindSocket(el, type, io) {\n        this.clearSockets();\n        this.sockets.set(io, new SocketView(el, type, io, this.node, this));\n    }\n\n    bindControl(el, control) {\n        this.controls.set(control, new ControlView(el, control, this));\n    }\n\n    getSocketPosition(io) {\n        const socket = this.sockets.get(io);\n\n        if (!socket) throw new Error(`Socket not found for ${io.name} with key ${io.key}`);\n\n        return socket.getPosition(this.node);\n    }\n\n    onSelect(e) {\n        const payload = { node: this.node, accumulate: e.ctrlKey, e };\n    \n        this.onStart();\n        this.trigger('multiselectnode', payload);\n        this.trigger('selectnode', payload);\n    }\n\n    onStart() {\n        this._startPosition = [...this.node.position];\n    }\n\n    onTranslate(dx, dy) {\n        this.trigger('translatenode', { node: this.node, dx, dy });\n    }\n\n    onDrag(dx, dy) {\n        const x = this._startPosition[0] + dx;\n        const y = this._startPosition[1] + dy;\n\n        this.translate(x, y);\n    }\n\n    translate(x, y) {\n        const node = this.node;\n        const params = { node, x, y };\n\n        if (!this.trigger('nodetranslate', params)) return;\n\n        const [px, py] = node.position;\n        const prev = [px, py];\n\n        node.position[0] = params.x;\n        node.position[1] = params.y;\n\n        this.update();\n        this.trigger('nodetranslated', { node, prev });\n    }\n\n    update() {\n        const [x, y] = this.node.position;\n\n        this.el.style.transform = `translate(${x}px, ${y}px)`;\n    }\n\n    remove() {\n        \n    }\n\n    destroy() {\n        this._drag.destroy();\n    }\n}\n"],"file":"node.js"}