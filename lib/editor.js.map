{"version":3,"sources":["../src/editor.js"],"names":["NodeEditor","Context","constructor","id","container","EditorEvents","Selected","view","EditorView","components","on","e","trigger","node","accumulate","selectNode","selected","each","n","nodeView","nodes","get","onStart","dx","dy","onDrag","addNode","push","removeNode","getConnections","forEach","c","removeConnection","splice","indexOf","connect","output","input","data","connection","connectTo","addConnection","remove","Error","add","getComponent","name","component","register","editor","clear","toJSON","beforeImport","json","checking","Validator","validate","success","msg","silent","afterImport","fromJSON","Promise","all","Object","keys","map","build","Node","jsonNode","outputs","key","outputJson","connections","jsonConnection","nodeId","targetOutput","targetInput","inputs"],"mappings":"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","sourcesContent":["import { Context, Validator } from './core.js';\nimport { EditorEvents } from './events.js';\nimport { Node } from './node.js';\nimport { Selected } from './selected.js';\nimport { EditorView } from './view/index.js';\nimport { listenWindow } from './view/utils.js';\nimport { Component } from './component.js';\n\n\nexport class NodeEditor extends Context {\n\n    nodes = [];\n    selected = new Selected();\n    view;\n\n    constructor(id, container) {\n        super(id, new EditorEvents());\n\n        this.view = new EditorView(container, this.components, this);\n\n        this.on('destroy', listenWindow('keydown', e => this.trigger('keydown', e)));\n        this.on('destroy', listenWindow('keyup', e => this.trigger('keyup', e)));\n\n        this.on('selectnode', ({ node, accumulate }) => this.selectNode(node, accumulate));\n        this.on('nodeselected', () => this.selected.each(n => {\n            const nodeView = this.view.nodes.get(n);\n\n            nodeView && nodeView.onStart()\n        }));\n        this.on('translatenode', ({ dx, dy }) => this.selected.each(n => {\n            const nodeView = this.view.nodes.get(n);\n\n            nodeView && nodeView.onDrag(dx, dy)\n        }));\n    }\n\n    addNode(node) {\n        if (!this.trigger('nodecreate', node)) return;\n\n        this.nodes.push(node);\n        this.view.addNode(node);\n\n        this.trigger('nodecreated', node);\n    }\n\n    removeNode(node) {\n        if (!this.trigger('noderemove', node)) return;\n\n        node.getConnections().forEach(c => this.removeConnection(c));\n\n        this.nodes.splice(this.nodes.indexOf(node), 1);\n        this.view.removeNode(node);\n\n        this.trigger('noderemoved', node);\n    }\n\n    connect(output, input, data = {}) {\n        if (!this.trigger('connectioncreate', { output, input })) return;\n\n        try {\n            const connection = output.connectTo(input);\n\n            connection.data = data;\n            this.view.addConnection(connection);\n\n            this.trigger('connectioncreated', connection);\n        } catch (e) {\n            this.trigger('warn', e)\n        }\n    }\n\n    removeConnection(connection) {\n        if (!this.trigger('connectionremove', connection)) return;\n\n        this.view.removeConnection(connection);\n        connection.remove();\n\n        this.trigger('connectionremoved', connection);\n    }\n\n    selectNode(node, accumulate = false) {\n        if (this.nodes.indexOf(node) === -1)\n            throw new Error('Node not exist in list');\n\n        if (!this.trigger('nodeselect', node)) return;\n\n        this.selected.add(node, accumulate);\n\n        this.trigger('nodeselected', node);\n    }\n\n    getComponent(name) {\n        const component = this.components.get(name);\n\n        if (!component)\n            throw `Component ${name} not found`;\n\n        return component;\n    }\n\n    register(component) {\n        super.register(component)\n        component.editor = this;\n    }\n\n    clear() {\n        [...this.nodes].forEach(node => this.removeNode(node));\n        this.trigger('clear');\n    }\n\n    toJSON() {\n        const data = { id: this.id, nodes: {} };\n\n        this.nodes.forEach(node => data.nodes[node.id] = node.toJSON());\n        this.trigger('export', data);\n        return data;\n    }\n\n    beforeImport(json) {\n        const checking = Validator.validate(this.id, json);\n\n        if (!checking.success) {\n            this.trigger('warn', checking.msg);\n            return false;\n        }\n\n        this.silent = true;\n        this.clear();\n        this.trigger('import', json);\n        return true;\n    }\n\n    afterImport() {\n        this.silent = false;\n        return true;\n    }\n\n    async fromJSON(json) {\n        if (!this.beforeImport(json)) return false;\n        const nodes = {};\n\n        try {\n            await Promise.all(Object.keys(json.nodes).map(async id => {\n                const node = json.nodes[id];\n                const component = this.getComponent(node.name);\n                //console.log(component)\n                //throw new Error(component)\n\n\n                nodes[id] = await component.build(Node.fromJSON(node));\n                this.addNode(nodes[id]);\n            }));\n\n            Object.keys(json.nodes).forEach(id => {\n                const jsonNode = json.nodes[id];\n                const node = nodes[id];\n\n                Object.keys(jsonNode.outputs).forEach(key => {\n                    const outputJson = jsonNode.outputs[key];\n\n                    outputJson.connections.forEach(jsonConnection => {\n                        const nodeId = jsonConnection.node;\n                        const data = jsonConnection.data;\n                        const targetOutput = node.outputs.get(key);\n                        const targetInput = nodes[nodeId].inputs.get(jsonConnection.input);\n\n                        if (!targetOutput || !targetInput) {\n                            return this.trigger('error', `IO not found for node ${node.id}`);\n                        }\n\n                        this.connect(targetOutput, targetInput, data);\n                    });\n                });\n\n            });\n        } catch (e) {\n            this.trigger('warn', e);\n            return !this.afterImport();\n        }\n\n        return this.afterImport();\n    }\n}"],"file":"editor.js"}